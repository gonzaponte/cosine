#include "types.hh"
#include "materials/silicon.hh"

#include <G4SystemOfUnits.hh>

#include <n4-constants.hh>
#include <n4-material.hh>
#include <n4-sequences.hh>

#include <algorithm>

using CLHEP::eV;

G4MaterialPropertiesTable *silicon_mpt() {
  auto tiny = 1*micrometer;

  auto wls = n4::scale_by(nm, { 109.979, 110.233, 110.487, 110.741, 110.997, 111.253, 111.509, 111.766, 112.024, 112.282
                              , 112.541, 112.800, 113.060, 113.321, 113.582, 113.844, 114.106, 114.369, 114.633, 114.897
                              , 115.162, 115.428, 115.694, 115.960, 116.228, 116.496, 116.764, 117.033, 117.303, 117.574
                              , 117.845, 118.116, 118.389, 118.662, 118.935, 119.209, 119.484, 119.759, 120.036, 120.312
                              , 120.590, 120.868, 121.146, 121.425, 121.705, 121.986, 122.267, 122.549, 122.832, 123.115
                              , 123.398, 123.683, 123.968, 124.254, 124.540, 124.827, 125.115, 125.404, 125.693, 125.982
                              , 126.273, 126.564, 126.856, 127.148, 127.441, 127.735, 128.029, 128.325, 128.620, 128.917
                              , 129.214, 129.512, 129.811, 130.110, 130.410, 130.710, 131.012, 131.314, 131.616, 131.920
                              , 132.224, 132.529, 132.834, 133.140, 133.447, 133.755, 134.063, 134.372, 134.682, 134.993
                              , 135.304, 135.616, 135.928, 136.242, 136.556, 136.871, 137.186, 137.502, 137.819, 138.137
                              , 138.455, 138.775, 139.094, 139.415, 139.737, 140.059, 140.382, 140.705, 141.029, 141.355
                              , 141.680, 142.007, 142.334, 142.663, 142.991, 143.321, 143.651, 143.983, 144.314, 144.647
                              , 144.981, 145.315, 145.650, 145.986, 146.322, 146.659, 146.997, 147.336, 147.676, 148.016
                              , 148.358, 148.700, 149.042, 149.386, 149.730, 150.076, 150.421, 150.768, 151.116, 151.464
                              , 151.813, 152.163, 152.514, 152.866, 153.218, 153.571, 153.925, 154.280, 154.636, 154.992
                              , 155.350, 155.708, 156.067, 156.426, 156.787, 157.148, 157.511, 157.874, 158.238, 158.602
                              , 158.968, 159.335, 159.702, 160.070, 160.439, 160.809, 161.180, 161.551, 161.923, 162.297
                              , 162.671, 163.046, 163.422, 163.798, 164.176, 164.555, 164.934, 165.314, 165.695, 166.077
                              , 166.460, 166.844, 167.228, 167.614, 168.000, 168.388, 168.776, 169.165, 169.555, 169.946
                              , 170.337, 170.730, 171.124, 171.518, 171.913, 172.310, 172.707, 173.105, 173.504, 173.904
                              , 174.305, 174.707, 175.110, 175.513, 175.918, 176.323, 176.730, 177.137, 177.546, 177.955
                              , 178.365, 178.776, 179.188, 179.601, 180.015, 180.430, 180.846, 181.263, 181.681, 182.100
                              , 182.520, 182.941, 183.362, 183.785, 184.209, 184.633, 185.059, 185.485, 185.913, 186.342
                              , 186.771, 187.202, 187.633, 188.066, 188.499, 188.934, 189.369, 189.806, 190.244, 190.682
                              , 191.122, 191.562, 192.004, 192.446, 192.890, 193.335, 193.780, 194.227, 194.675, 195.124
                              });
  auto ref_index = n4::scale_by(1, { 0.263486581352, 0.265363075078, 0.267282365130, 0.269246926950, 0.271259841850
                                   , 0.273323937068, 0.275442537375, 0.277619277407, 0.279857670334, 0.282161745956
                                   , 0.284535490766, 0.286982985337, 0.289508897911, 0.292117077891, 0.294811997545
                                   , 0.297597705110, 0.300478304756, 0.303456898662, 0.306536730632, 0.309720047491
                                   , 0.313008265947, 0.316401869215, 0.319899867141, 0.323500117514, 0.327199012241
                                   , 0.330990758088, 0.334867978254, 0.338821305932, 0.342839305362, 0.346908058071
                                   , 0.351012306972, 0.355134012741, 0.359253783898, 0.363350414249, 0.367401182821
                                   , 0.371382741206, 0.375270951340, 0.379041612379, 0.382671625813, 0.386139096628
                                   , 0.389424852928, 0.392513607485, 0.395394773091, 0.398063676718, 0.400521861810
                                   , 0.402777334849, 0.404843973318, 0.406739993290, 0.408486058205, 0.410103052570
                                   , 0.411610532075, 0.413024392537, 0.414357650167, 0.415619282246, 0.416815839203
                                   , 0.417952603768, 0.419034756078, 0.420068726979, 0.421062163047, 0.422024835259
                                   , 0.422968035810, 0.423903881923, 0.424844847457, 0.425803172983, 0.426790460887
                                   , 0.427816698486, 0.428890904981, 0.430019881194, 0.431209472340, 0.432463376711
                                   , 0.433784013891, 0.435172705136, 0.436629074620, 0.438152271932, 0.439740650300
                                   , 0.441391460715, 0.443102057648, 0.444869130708, 0.446689386901, 0.448559407276
                                   , 0.450475682030, 0.452435180163, 0.454434814149, 0.456471626086, 0.458543099861
                                   , 0.460646785546, 0.462780776462, 0.464943199099, 0.467132607539, 0.469347693066
                                   , 0.471587341017, 0.473850481780, 0.476136454968, 0.478444483720, 0.480773644579
                                   , 0.483123061818, 0.485491915721, 0.487878817542, 0.490282246927, 0.492700321813
                                   , 0.495130699250, 0.497570667404, 0.500016881898, 0.502465504089, 0.504912088305
                                   , 0.507351864094, 0.509779582305, 0.512189506623, 0.514576126086, 0.516933442171
                                   , 0.519255855012, 0.521538385151, 0.523776289165, 0.525965960527, 0.528104719557
                                   , 0.530191223925, 0.532225581915, 0.534209546814, 0.536146316185, 0.538040821012
                                   , 0.539899753664, 0.541731143258, 0.543544497794, 0.545350092127, 0.547159352977
                                   , 0.548984100408, 0.550836435683, 0.552728221704, 0.554671003537, 0.556675489296
                                   , 0.558751458235, 0.560907419575, 0.563150675246, 0.565486387273, 0.567915706016
                                   , 0.570439552531, 0.573058194959, 0.575770069517, 0.578572068404, 0.581459422297
                                   , 0.584426020224, 0.587464211666, 0.590565205033, 0.593718797037, 0.596913939874
                                   , 0.600138398731, 0.603379174749, 0.606622517642, 0.609854243234, 0.613059572212
                                   , 0.616223641605, 0.619331499323, 0.622368510357, 0.625320469950, 0.628173879724
                                   , 0.630916254238, 0.633536560963, 0.636025031259, 0.638374057808, 0.640577830366
                                   , 0.642632888489, 0.644538165335, 0.646295004487, 0.647907333364, 0.649381348066
                                   , 0.650725851628, 0.651951609608, 0.653071383975, 0.654099469753, 0.655051652788
                                   , 0.655944380649, 0.656794731779, 0.657619923268, 0.658436859581, 0.659261743042
                                   , 0.660110073941, 0.660995787881, 0.661931562416, 0.662928466492, 0.663995764092
                                   , 0.665140939406, 0.666369902918, 0.667686786920, 0.669094236306, 0.670593742058
                                   , 0.672185377413, 0.673868574268, 0.675642054084, 0.677504225399, 0.679453186228
                                   , 0.681487219643, 0.683604763498, 0.685804591001, 0.688085820913, 0.690447970019
                                   , 0.692890936156, 0.695414850783, 0.698019882765, 0.700706117880, 0.703473479344
                                   , 0.706321385879, 0.709248597624, 0.712253339414, 0.715332810951, 0.718483534916
                                   , 0.721701280533, 0.724980898701, 0.728316666451, 0.731702287417, 0.735130987951
                                   , 0.738595600658, 0.742088600113, 0.745602213892, 0.749128823609, 0.752662619489
                                   , 0.756203884246, 0.759767629263, 0.763395885701, 0.767168062480, 0.771197421225
                                   , 0.775604020688, 0.780467546506, 0.785783250746, 0.791451850892, 0.797314221899
                                   , 0.803211794591, 0.809036803908, 0.814748177961, 0.820355773721, 0.825892396439
                                   , 0.831391530849, 0.836877436770, 0.842364308990, 0.847859497953, 0.853366643679
                                   , 0.858887616479, 0.864423580476, 0.869975375847, 0.875543785837, 0.881129466661
                                   , 0.886733154124, 0.892355543947, 0.897997316201, 0.903659214620, 0.909341900080
                                   , 0.915046107745, 0.920772570710, 0.926522051788, 0.932295249895, 0.938092857566});

  auto energies  = n4::map<f64>([](f64 wl) {return c4::hc/wl;} , wls); // energies expressed in internal unit
  std::reverse(energies .begin(), energies .end());
  std::reverse(ref_index.begin(), ref_index.end());

  /// TODO: adjust efficiency to sipm specs
  // auto efficiency = 0.25;

  auto qe = 0.24;

  return n4::material_properties()
    // .add("EFFICIENCY" , energies, efficiency)    // this is doing nothing, as it
                                                    // applies only to the skin which has no reflectivity set
    // .add("REFLECTIVITY", energies, reflectivity) // ignored. relying on refractive indices
    .NEW("QUANTUM_EFFICIENCY", energies,     qe)    // we implement an effective QE for detection efficiency
    .add("ABSLENGTH"   , energies,         tiny)
    .add("RINDEX"      , energies,    ref_index)
    .done();
}

G4Material* silicon_with_properties() {
  auto silicon = n4::material("G4_Si");

  silicon -> SetMaterialPropertiesTable(silicon_mpt());
  return silicon;
}

G4OpticalSurface* silicon_surface() {
  auto surface = new G4OpticalSurface("silicon_surface", unified, polished, dielectric_dielectric);
  surface -> SetMaterialPropertiesTable(silicon_mpt());
  return surface;
}
